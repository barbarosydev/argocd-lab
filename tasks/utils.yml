version: '3'

tasks:
  clean:
    desc: Clean artifacts (FULL_CLEAN=1 stops lab, DOCKER_CLEAN=1 removes images)
    silent: true
    deps:
      - task: :docs:clean
    cmds:
      - |
          [[ "${FULL_CLEAN:-${LAB_FULL_CLEAN:-0}}" == "1" ]] && task lab:stop || true
          rm -f /tmp/argocd-port-forward*.log
          find . -type d -name __pycache__ -not -path "*/site/*" -exec rm -rf {} + 2>/dev/null || true
          if [[ "${DOCKER_CLEAN:-${LAB_DOCKER_CLEAN:-0}}" == "1" ]]; then
            docker images --format '{{.Repository}}:{{.Tag}} {{.ID}}' 2>/dev/null | awk '$1 ~ /^demo-api:/ {print $2}' | xargs -r docker rmi -f 2>/dev/null || true
          fi
          echo "[clean] Done"

  install:
    desc: Install required dependencies
    silent: true
    cmds:
      - ./scripts/setup-dependencies.sh

  update:
    desc: Update all dependencies
    silent: true
    deps:
      - task: :quality:pre-commit:update
    cmds:
      - brew upgrade kubectl helm minikube 2>/dev/null || echo "[update] Homebrew not available"

  info:
    desc: Show lab environment information
    silent: true
    cmds:
      - |
          echo "[info] === ArgoCD Lab ==="
          K=$(kubectl version --client -o json 2>/dev/null | jq -r '.clientVersion.gitVersion' || echo 'N/A')
          H=$(helm version --short 2>/dev/null || echo 'N/A')
          M=$(minikube version --short 2>/dev/null || echo 'N/A')
          echo "[info] Tools: kubectl=$K helm=$H minikube=$M"
          echo "[info] Config: profile={{.PROFILE}} k8s={{.K8S_VERSION}} ns={{.ARGOCD_NAMESPACE}} port={{.ARGOCD_PORT}}"
