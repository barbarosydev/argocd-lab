version: '3'

dotenv:
  - .env

# Global configuration
vars:
  PROFILE: '{{.LAB_MINIKUBE_PROFILE | default "argocd-lab"}}'
  K8S_VERSION: '{{.LAB_K8S_VERSION | default "v1.35.0"}}'
  ARGOCD_NAMESPACE: '{{.LAB_ARGOCD_NAMESPACE | default "argocd"}}'
  ARGOCD_PORT: '{{.LAB_ARGOCD_PORT | default 8081}}'
  ARGO_VALUES: '{{.LAB_ARGO_VALUES | default "k8s/argocd/values.yaml"}}'

# Include task modules
includes:
  lab: ./tasks/lab.yml
  argocd: ./tasks/argocd.yml
  docs: ./tasks/docs.yml
  quality: ./tasks/quality.yml
  utils: ./tasks/utils.yml

# Top-level convenience tasks
tasks:
  default:
    desc: Show available tasks
    silent: true
    cmds:
      - task --list

  start:
    desc: "ğŸš€ Start lab"
    silent: true
    cmds:
      - task: lab:start

  stop:
    desc: "ğŸ›‘ Stop lab"
    silent: true
    cmds:
      - task: lab:stop

  status:
    desc: "ğŸ“Š Check status"
    silent: true
    cmds:
      - task: lab:status

  ui:
    desc: "ğŸŒ Open ArgoCD UI"
    silent: true
    cmds:
      - task: argocd:ui

  deploy:
    desc: "ğŸ“¦ Deploy app"
    silent: true
    cmds:
      - task: argocd:deploy-app

  undeploy:
    desc: "ğŸ—‘ï¸  Undeploy app"
    silent: true
    cmds:
      - task: argocd:undeploy-app

  validate:
    desc: "âœ… Run validation"
    silent: true
    cmds:
      - task: quality:validate

  install:
    desc: "ğŸ“¥ Install dependencies"
    silent: true
    cmds:
      - task: utils:install

  init:
    desc: "Create .env from template"
    silent: true
    cmds:
      - |
          if [ -f .env ]; then
            echo "[init] .env already exists"
          else
            cp env.example .env
            echo "[init] Created .env from env.example"
          fi

  info:
    desc: "â„¹ï¸  Show lab info"
    silent: true
    cmds:
      - task: utils:info

  _check-deps:
    desc: Check if required commands are installed
    internal: true
    silent: true
    preconditions:
      - sh: command -v kubectl
        msg: "kubectl is not installed. Run 'task install' first"
      - sh: command -v helm
        msg: "helm is not installed. Run 'task install' first"
      - sh: command -v minikube
        msg: "minikube is not installed. Run 'task install' first"

  _check-cluster:
    desc: Check if Minikube cluster is running
    internal: true
    silent: true
    preconditions:
      - sh: minikube status -p {{.PROFILE}} >/dev/null 2>&1
        msg: "Minikube cluster is not running. Run 'task start' first"
